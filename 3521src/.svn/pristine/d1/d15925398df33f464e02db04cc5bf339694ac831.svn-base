/*************************************** Copyright ******************************
*
* (C) Copyright 2022, Shaanxi Tianji Communication
* All Rights Reserved
*                         
* FileName   : app_version.h   
* Version    : none		
* Author     : none			
* Date       : 2024-02-26        
* Description: version   
*******************************************************************************/
#ifndef __APP_VERSION_H_
#define __APP_VERSION_H_

#define VER_EXE_SUCCESS 0  /*执行成功*/
#define VER_EXE_FAIL    1  /*执行失败*/

/*FLASH空间规划 升级信息*/
#define VER_FLASH_UPDATE_INFO_SECTOR    16    /*升级信息	升级状态	4	16	16*/

/*FLASH空间规划 备份区*/
#define VER_FLASH_BAK_MCU_BOOT_S_SECTOR 18    /*备份区	MCU BOOT备份固件区	100	18	42*/
#define VER_FLASH_BAK_MCU_BOOT_E_SECTOR 42    /*备份区	MCU BOOT备份固件区	100	18	42*/

#define VER_FLASH_BAK_MCU_APP_S_SECTOR  43    /*备份区	MCU APP备份固件区	500	43	167*/
#define VER_FLASH_BAK_MCU_APP_E_SECTOR  167   /*备份区	MCU APP备份固件区	500	43	167*/
									    
#define VER_FLASH_BAK_8668_B3_S_SECTOR  168   /*备份区	8668 BIN文件备份1	60	168	182*/
#define VER_FLASH_BAK_8668_B3_E_SECTOR  182   /*备份区	8668 BIN文件备份1	60	168	182*/
									    
#define VER_FLASH_BAK_8668_B8_S_SECTOR  183   /*备份区	8668 BIN文件备份2	60	183	197*/
#define VER_FLASH_BAK_8668_B8_E_SECTOR  197   /*备份区	8668 BIN文件备份2	60	183	197*/

#define VER_FLASH_BAK_8668_B39_S_SECTOR 198   /*备份区	8668 BIN文件备份3	60	198	212*/
#define VER_FLASH_BAK_8668_B39_E_SECTOR 212   /*备份区	8668 BIN文件备份3	60	198	212*/
											  
#define VER_FLASH_BAK_8668_B40_S_SECTOR 213   /*备份区	8668 BIN文件备份4	60	213	227*/
#define VER_FLASH_BAK_8668_B40_E_SECTOR 227   /*备份区	8668 BIN文件备份4	60	213	227*/
											  
#define VER_FLASH_BAK_8668_N41_S_SECTOR 228   /*备份区	8668 BIN文件备份5	60	228	242*/
#define VER_FLASH_BAK_8668_N41_E_SECTOR 242   /*备份区	8668 BIN文件备份5	60	228	242*/

#define VER_FLASH_BAK_FPGA_S_SECTOR     243   /*备份区	FPGA备份固件区	200	243	292*/
#define VER_FLASH_BAK_FPGA_E_SECTOR     292   /*备份区	FPGA备份固件区	200	243	292*/

/*FLASH空间规划 工作固件区*/
#define VER_FLASH_WORK_MCU_BOOT_S_SECTOR 293   /*工作固件区	MCU BOOT固件	100	293	317*/
#define VER_FLASH_WORK_MCU_BOOT_E_SECTOR 317   /*工作固件区	MCU BOOT固件	100	293	317*/

#define VER_FLASH_WORK_MCU_APP_S_SECTOR  318   /*工作固件区	MCU APP工作固件	500	318	442*/
#define VER_FLASH_WORK_MCU_APP_E_SECTOR  442   /*工作固件区	MCU APP工作固件	500	318	442*/
										 
#define VER_FLASH_WORK_8668_B3_S_SECTOR  443   /*工作固件区	8668 BIN文件1	60	443	457*/
#define VER_FLASH_WORK_8668_B3_E_SECTOR  457   /*工作固件区	8668 BIN文件1	60	443	457*/
										 
#define VER_FLASH_WORK_8668_B8_S_SECTOR  458   /*工作固件区	8668 BIN文件2	60	458	472*/
#define VER_FLASH_WORK_8668_B8_E_SECTOR  472   /*工作固件区	8668 BIN文件2	60	458	472*/

#define VER_FLASH_WORK_8668_B39_S_SECTOR 473  /*工作固件区	8668 BIN文件3	60	473	487*/
#define VER_FLASH_WORK_8668_B39_E_SECTOR 487  /*工作固件区	8668 BIN文件3	60	473	487*/

#define VER_FLASH_WORK_8668_B40_S_SECTOR 488  /*工作固件区	8668 BIN文件4	60	488	502*/
#define VER_FLASH_WORK_8668_B40_E_SECTOR 502  /*工作固件区	8668 BIN文件4	60	488	502*/

#define VER_FLASH_WORK_8668_N41_S_SECTOR 503  /*工作固件区	8668 BIN文件5	60	503	517*/
#define VER_FLASH_WORK_8668_N41_E_SECTOR 517  /*工作固件区	8668 BIN文件5	60	503	517*/

#define VER_FLASH_WORK_FPGA_S_SECTOR     518  /*工作固件区	FPGA固件区	200	518	567*/
#define VER_FLASH_WORK_FPGA_E_SECTOR     567  /*工作固件区	FPGA固件区	200	518	567*/

/*FLASH空间规划 文件接收区*/
#define VER_FLASH_FILE_RECV_S_SECTOR     568  /*文件接收区	文件接收区	4096	568	1591*/
#define VER_FLASH_FILE_RECV_E_SECTOR     1591 /*文件接收区	文件接收区	4096	568	1591*/	
	
/*FLASH空间规划 奕斯伟5G猫 （主机）*/
#define VER_FLASH_BAK_5G_MODEM_S_SECTOR  1592 /*奕斯伟5G猫备份固件区	4096	1592	2615*/
#define VER_FLASH_BAK_5G_MODEM_E_SECTOR  2615 /*奕斯伟5G猫备份固件区	4096	1592	2615*/		
	
#define VER_FLASH_WORK_5G_MODEM_S_SECTOR 2616 /*奕斯伟5G猫固件区	4096	2616	3639*/
#define VER_FLASH_WORK_5G_MODEM_E_SECTOR 3639 /*奕斯伟5G猫固件区	4096	2616	3639*/		
	
/*FLASH空间规划 从机升级固件区 （主机）*/
#define VER_FLASH_RU_MCU_BOOT_S_SECTOR   3640 /*从机升级固件区	MCU BOOT固件	100	3640	3664*/
#define VER_FLASH_RU_MCU_BOOT_E_SECTOR   3664 /*从机升级固件区	MCU BOOT固件	100	3640	3664*/

#define VER_FLASH_RU_MCU_APP_S_SECTOR    3665 /*从机升级固件区	MCU APP工作固件	500	3665	3789*/
#define VER_FLASH_RU_MCU_APP_E_SECTOR    3789 /*从机升级固件区	MCU APP工作固件	500	3665	3789*/
									     
#define VER_FLASH_RU_8668_B3_S_SECTOR    3790 /*从机升级固件区	8668 BIN文件1	60	3790	3804*/
#define VER_FLASH_RU_8668_B3_E_SECTOR    3804 /*从机升级固件区	8668 BIN文件1	60	3790	3804*/
									     
#define VER_FLASH_RU_8668_B8_S_SECTOR    3805 /*从机升级固件区	8668 BIN文件2	60	3805	3819*/
#define VER_FLASH_RU_8668_B8_E_SECTOR    3819 /*从机升级固件区	8668 BIN文件2	60	3805	3819*/

#define VER_FLASH_RU_8668_B39_S_SECTOR   3820 /*从机升级固件区	8668 BIN文件3	60	3820	3834*/
#define VER_FLASH_RU_8668_B39_E_SECTOR   3834 /*从机升级固件区	8668 BIN文件3	60	3820	3834*/
									     
#define VER_FLASH_RU_8668_B40_S_SECTOR   3835 /*从机升级固件区	8668 BIN文件4	60	3835	3849*/
#define VER_FLASH_RU_8668_B40_E_SECTOR   3849 /*从机升级固件区	8668 BIN文件4	60	3835	3849*/
									     
#define VER_FLASH_RU_8668_N41_S_SECTOR   3850 /*从机升级固件区	8668 BIN文件5	60	3850	3864*/
#define VER_FLASH_RU_8668_N41_E_SECTOR   3864 /*从机升级固件区	8668 BIN文件5	60	3850	3864*/

#define VER_FLASH_RU_FPGA_S_SECTOR       3865 /*从机升级固件区	FPGA固件区	200	3865	3914*/
#define VER_FLASH_RU_FPGA_E_SECTOR       3914 /*从机升级固件区	FPGA固件区	200	3865	3914*/
	
/*升级文件头信息*/
#define VER_FILE_HEAD_LEN        512	/*升级文件头长度*/
#define VER_FILE_HEAD_START_BYTE 0x55AA	/*升级文件头开始字节*/	

#define VER_TYPE_WORK  0
#define VER_TYPE_BAK   1
	
/*升级文件设备类型定义*/	
#define VER_DEVICE_MU         0x01/*主机*/
#define VER_DEVICE_RU         0x02/*从机*/
#define VER_DEVICE_THIRD_RU   0x03/*三级从机*/
#define VER_DEVICE_HUB        0x04/*HUB*/
#define VER_DEVICE_OTHER      0xF0/*无差别设备*/

/*升级文件模块类型定义*/		
#define VER_MODULE_MCU_BOOT   0x00/*MCU_BOOT*/
#define VER_MODULE_MCU_APP    0x01/*MCU_APP*/
#define VER_MODULE_BLE        0x02/*BLE*/
#define VER_MODULE_FPGA       0x03/*FPGA*/
#define VER_MODULE_5G_MODEM   0x04/*5G MODEM*/
#define VER_MODULE_MONITOR    0x05/*监控模组*/
#define VER_MODULE_8668_BIN1  0x06/*8668 bin文件1(B3)*/
#define VER_MODULE_8668_BIN2  0x07/*8668 bin文件2(B8)*/
#define VER_MODULE_8668_BIN3  0x08/*8668 bin文件3(B39)*/
#define VER_MODULE_8668_BIN4  0x09/*8668 bin文件4(B40)*/
#define VER_MODULE_8668_BIN5  0x0A/*8668 bin文件5(N41)*/
#define VER_MODULE_8668_BIN6  0x0B/*8668 bin文件6*/
#define VER_MODULE_8668_BIN7  0x0C/*8668 bin文件7*/
#define VER_MODULE_8668_BIN8  0x0D/*8668 bin文件8*/
#define VER_MODULE_8668_BIN9  0x0E/*8668 bin文件9*/
#define VER_MODULE_8668_BIN10 0x0F/*8668 bin文件10*/

/*升级数据宏定义*/
#define VER_UPGRADE_PACKET_SIZE		(600)    /*升级数据包的长度*/
#define VER_UPGRADE_DATA_BUF_SIZE   (1024)	 /*升级数据缓冲区的长度*/

#if (VER_UPGRADE_PACKET_SIZE > VER_UPGRADE_DATA_BUF_SIZE)
#error "The update packet length can't exceed the specified size!!!"
#endif	

/*升级状态定义*/	
typedef enum
{
    EN_VER_UPGRADE_SUCCESS                  = 0x00,             /*升级成功               */
    EN_VER_UPGRADE_WE_FLASH_FAIL,                               /*写擦flash失败          */
    EN_VER_UPGRADE_FILE_TOO_LAGER,                              /*固件过大               */
    EN_VER_UPGRADE_FILE_CRC_FAIL,                               /*CRC校验失败            */
	EN_VER_UPGRADE_FILE_INFO_ERROR,                             /*固件信息错误           */
	EN_VER_UPGRADE_FILE_MOVE_FAIL,                              /*固件搬移失败           */
	EN_VER_UPGRADE_MCU_TYPE_ERROR,                              /*MCU类型错误            */
	EN_VER_UPGRADE_FILE_LOAF_FAIL,                              /*固件加载失败           */
    EN_VER_UPGRADE_UNDONE,                                      /*升级未完成             */
    EN_VER_UPGRADE_BOOTLOADER_COPY_ERR,                         /*bootloader拷贝失败     */
    EN_VER_UPGRADE_TSP_CANCLE_UPGRADE_SERVICE,                  /*TSP取消升级            */
    EN_VER_UPGRADE_UPGRADE_STOP_BY_MAN_NUM_ERR,                 /*升级终止由于厂商号错误 */
    EN_VER_UPGRADE_UPGRADE_STOP_BY_DEV_NUM_ERR,                 /*升级终止由于设备号错误 */
    EN_VER_UPGRADE_UPGRADE_STOP_BY_OTHER,                       /*升级终止由于其他问题   */
    EN_VER_UPGRADE_UPGRADE_APP_RUN_TIMEOUT,                     /*APP运行超时            */
} EN_VER_UPGRADE_INSTRUCTION;	

/*结构体定义*/
typedef struct
{
    uint32_t   ulDatalen;
    uint8_t    ucaData[VER_UPGRADE_DATA_BUF_SIZE];
	uint32_t   ulWriteOffset;
} stVerUpgradeFormat, *pstVerUpgradeFormat;
	
/*版本文件信息*/
typedef struct
{
    uint8_t    ucDeviceType;   /*设备类型,  0x01:主机 0x02:从机 0x03:三级从机 0x04:HUB 0xF0:无差别设备*/
	uint8_t    ucModuleType;   /*模块类型,  0x00:MCU_BOOT 0x01:MCU_APP 0x02:BLE 0x03:FPGA 0x04:5G MODEM 0x05:监控模组 0x06:8668 bin文件1(B3) 0x07:8668 bin文件2(B8) 0x08:8668 bin文件3(B39) 0x09:8668 bin文件4(B40) 0x0A:8668 bin文件5(N41) 0x0B:8668 bin文件6 0x0C:8668 bin文件7 0x0D:8668 bin文件8 0x0E:8668 bin文件9 0x0F:8668 bin文件10*/
	uint8_t    ucaMcuType[32]; /*MCU型号,   字符串 GD32F427ZET6 STM32F407ZET6*/
	uint32_t   ulSoftVersion; /*软件版本,  十进制,如23010101*/
	uint32_t   ulBinFileLen;  /*文件长度,  原始可执行的bin文件长度*/
	uint32_t   ulBinFileValid;/*文件有效性,原始BIN文件位于0x1000~0x1003字节的32位数据 Data1和位于0x1FFC~0x1FFF字节的32位数据 Data2进行异或*/
	uint32_t   ulBinFileCrc32;/*正确性验证,原始Bin文件的CRC校验码*/
} stVerFileInfo, *pstVerFileInfo;		

/*版本升级信息表定义*/
typedef uint8_t (*VER_UPDATE_FUNC)(uint32_t verIndex);
typedef struct
{ 
    uint8_t       ucVersionType; /*版本类型 0主用 1备用*/
    uint8_t       ucDeviceType;  /*设备类型*/
	uint8_t       ucModuleType;  /*模块类型*/
	uint32_t      ulFlashSSector;/*FLASH开始扇区*/
	uint32_t      ulFlashESector;/*FLASH结束扇区*/
	uint32_t      ulSoftVersion; /*软件版本号*/
	uint32_t      ulBinFileLen;  /*源文件长度*/
    VER_UPDATE_FUNC updateFunc;  /*版本更新功能实现*/
} stVerTable;	


/*APP升级标志定义*/
typedef enum
{
    UPG_FLAG_JUMP_TO_APP = 0,
    UPG_FLAG_FROM_UPGRADE_TO_APP, 
    UPG_FLAG_FROM_BACKUP_TO_APP, 
    UPG_FLAG_FROM_APP_TO_BACKUP,
    UPG_FLAG_FROM_UPGRADE_TO_BOOT,
    UPG_FLAG_END
} upg_flag_e;
#pragma pack(1)
typedef struct
{
    uint16_t start;				    /*起始字节*/  
    upg_flag_e  upg_flag; 		    /*升级标志  0:不升级, 1:升级APP, 2:版本回退, 3:升级BKP, 数据接收校验无误可升级, 置位1, 否则, 置位0*/ 
    uint8_t  upg_result;            /*升级结果  0:正常, 其他: 失败原因*/ 
    uint8_t  upg_fail_reason;       /*失败原因  保存固件校验结果*/ 
    uint32_t bootloader_version;    /*bootloader当前软件版本*/ 
    uint32_t app_version;	        /*当前app区软件版本, , APP正常运行后在APP中写入, 默认写入23010101*/ 
    uint8_t  report_flag;           /*上报升级状态, 1: 上报, 0:不上报, 参数初始化的时候, 由boot清零, 其他情况, 由app清零*/ 
    uint8_t  reboot_cnt;            /*重复运行状态判断, 初始值: 10, 在boot中设置为10, 在APP中设备正常运行后设置为0xFF,*/
									/*若REBOOT_CNT != 0xFF, 则每次上电在boot中自动-1, 6 ~ 10 之间为检测升级过程*/
									/*当REBOOT_CNT == 5, 设置回退版本标识*/
									/*当REBOOT_CNT == 0, 设置直接跳转APP标识*/
    uint8_t  complete_flg;			/*升级完之后标志位*/
	uint8_t  reserve[12];           /*预留参数 [0]用于判断5G modem是否需要升级*/ 
    uint32_t crc32;                 /*CRC校验值*/ 
} bootloader_info_t, *pst_bootloader_info;
#pragma pack()


void Ver_Init(void);
void Ver_Work(void);

uint8_t ver_FileTransInit(void);
uint8_t ver_FileTransEnd(void);
uint8_t ver_FileLoad(void);
uint8_t ver_FileDataSave(uint8_t *data, uint16_t datalen);

uint8_t ver_UpgradeTimeOutCtrl(uint8_t status);
uint8_t ver_UpgradeTimeValueClear(void);

uint8_t Ver_GetBinFile(uint8_t ucType, uint32_t *pAddr, uint32_t *pLen);
uint8_t Ver_GetRuFile(uint8_t ucType, uint32_t *pVer, uint32_t *pAddr, uint32_t *pLen);
uint8_t Ver_Get5gModemFile(uint32_t *pVer, uint32_t *pAddr, uint32_t *pLen);
uint8_t ver_Set5gModemUpgrade(uint8_t isUpgrade);
#endif

